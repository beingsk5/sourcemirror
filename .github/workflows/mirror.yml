name: Public SourceForge Mirror

on:
  workflow_dispatch:
    inputs:
      urls:
        required: true
        type: string
      job_id:
        required: true
        type: string

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare progress branch
        run: |
          git config user.name "progress-bot"
          git config user.email "progress@bot"

          if git show-ref --quiet refs/remotes/origin/progress; then
            git checkout progress
          else
            git checkout --orphan progress
            git rm -rf .
            mkdir -p progress
            git add progress
            git commit -m "init progress branch"
            git push origin progress
            git checkout -
            git checkout progress
          fi

      - name: Stage – validating
        run: |
          mkdir -p progress
          echo "validating" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage validating ${{ inputs.job_id }}"
          git push origin progress

      - name: Stage – downloading
        run: |
          echo "downloading" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage downloading ${{ inputs.job_id }}"
          git push origin progress
          sleep 10

      - name: Stage – uploading
        run: |
          echo "uploading" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage uploading ${{ inputs.job_id }}"
          git push origin progress
          sleep 10

      - name: Stage – verifying
        run: |
          echo "verifying" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage verifying ${{ inputs.job_id }}"
          git push origin progress
          sleep 5

      - name: Stage – finished
        if: always()
        run: |
          echo "finished" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage finished ${{ inputs.job_id }}"
          git push origin progress
