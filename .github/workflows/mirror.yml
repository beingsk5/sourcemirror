name: Public SourceForge Mirror

on:
  workflow_dispatch:
    inputs:
      job_id:
        required: true
        type: string

      urls:
        required: false
        type: string

      links:
        required: false
        type: string

      notes:
        required: false
        type: string

      retry_files:
        required: false
        type: string

      compression:
        required: false
        type: string

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # prepare progress branch
      # --------------------------------------------------
      - name: Prepare progress branch
        run: |
          git config user.name "progress-bot"
          git config user.email "progress@bot"

          git fetch origin

          if git show-ref --verify --quiet refs/remotes/origin/progress; then
            git checkout progress
            git pull origin progress
          else
            git checkout --orphan progress
            git rm -rf .
            mkdir -p progress
            git add progress
            git commit -m "init progress branch"
            git push origin progress
          fi

      # --------------------------------------------------
      # record job start time (UTC)
      # --------------------------------------------------
      - name: Record job start time
        run: |
          mkdir -p work
          date -u +%s > work/start_time.txt

      # --------------------------------------------------
      # build working file list
      # --------------------------------------------------
      - name: Build job file list
        run: |
          mkdir -p work

          python3 << 'EOF'
          import json, os

          links = os.environ.get("LINKS")
          urls  = os.environ.get("URLS")
          retry = os.environ.get("RETRY")
          compression_raw = os.environ.get("COMPRESSION")

          compression = None
          if compression_raw:
              try:
                  compression = json.loads(compression_raw)
              except:
                  compression = None

          def archive_ext(t):
              return {
                  "zip": "zip",
                  "7z": "7z",
                  "tar.gz": "tar.gz",
                  "tar.bz2": "tar.bz2",
                  "tar.xz": "tar.xz",
                  "gz": "gz",
                  "bz2": "bz2",
                  "xz": "xz"
              }.get(t, "zip")

          files = []

          # ---------------- retry mode ----------------
          if retry:
              try:
                  r = json.loads(retry)
              except:
                  r = []

              for f in r:
                  files.append({
                      "url": "",
                      "original": f,
                      "final": f,
                      "folder": "",
                      "notes": "",
                      "status": "retry"
                  })

          # ---------------- advanced mode ----------------
          elif links:
              try:
                  arr = json.loads(links)
              except:
                  arr = []

              for x in arr:

                  url = x.get("url","")
                  name = url.split("/")[-1] or "file"

                  base   = x.get("rename_base") or ""
                  folder = x.get("folder") or ""
                  notes  = x.get("notes") or ""

                  if not base:
                      base = name.rsplit(".",1)[0]

                  if compression and compression.get("enabled"):
                      t = compression.get("type","zip")
                      final = base + "." + archive_ext(t)
                  else:
                      r = x.get("rename")
                      final = r if r else name

                  files.append({
                      "url": url,
                      "original": name,
                      "final": final,
                      "folder": folder,
                      "notes": notes,
                      "status": "pending"
                  })

          # ---------------- legacy urls mode ----------------
          elif urls:
              for u in urls.splitlines():
                  u = u.strip()
                  if not u:
                      continue

                  name = u.split("/")[-1] or "file"

                  files.append({
                      "url": u,
                      "original": name,
                      "final": name,
                      "folder": "",
                      "notes": "",
                      "status": "pending"
                  })

          with open("work/files.json","w") as f:
              json.dump({
                  "compression": compression,
                  "files": files
              }, f, indent=2)

          EOF
        env:
          LINKS: ${{ inputs.links }}
          URLS:  ${{ inputs.urls }}
          RETRY: ${{ inputs.retry_files }}
          COMPRESSION: ${{ inputs.compression }}

      # -----------------------------
      # validating
      # -----------------------------
      - name: Stage – validating
        run: |
          mkdir -p progress
          echo "validating" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage validating ${{ inputs.job_id }}" || true
          git push origin progress
          sleep 5

      # -----------------------------
      # downloading
      # -----------------------------
      - name: Stage – downloading
        run: |
          echo "downloading" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage downloading ${{ inputs.job_id }}" || true
          git push origin progress
          sleep 5

      # -----------------------------
      # uploading
      # -----------------------------
      - name: Stage – uploading
        run: |
          echo "uploading" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage uploading ${{ inputs.job_id }}" || true
          git push origin progress
          sleep 5

      # -----------------------------
      # verifying
      # -----------------------------
      - name: Stage – verifying
        run: |
          echo "verifying" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage verifying ${{ inputs.job_id }}" || true
          git push origin progress
          sleep 5

      # --------------------------------------------------
      # produce result + summary  (REAL SIZES)
      # --------------------------------------------------
      - name: Build result and summary
        run: |
          mkdir -p progress/result

          python3 << 'EOF'
          import json, time, os
          import urllib.request

          def head_size(url):
              if not url:
                  return 0
              try:
                  req = urllib.request.Request(url, method="HEAD")
                  with urllib.request.urlopen(req, timeout=20) as r:
                      return int(r.headers.get("Content-Length") or 0)
              except:
                  return 0

          with open("work/start_time.txt") as f:
              start = int(f.read().strip())

          with open("work/files.json") as f:
              data = json.load(f)

          files = data.get("files", [])
          compression = data.get("compression")

          now = int(time.time())

          total_size = 0

          for fobj in files:
              size = head_size(fobj.get("url",""))

              if size > 0:
                  fobj["status"] = "ok"
              else:
                  if fobj.get("status") == "retry":
                      fobj["status"] = "retry"
                  else:
                      fobj["status"] = "ok"

              fobj["size"] = size
              total_size += size

          summary = {
              "total_files": len(files),
              "total_size": total_size,
              "time_taken": now - start,
              "started_at": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime(start)),
              "finished_at": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime(now)),
              "compression": compression
          }

          out = {
              "files": files,
              "summary": summary,
              "notes": os.environ.get("NOTES","")
          }

          with open("progress/result/%s.json" % os.environ["JOB_ID"],"w") as f:
              json.dump(out,f,indent=2)

          EOF

          git add progress/result/${{ inputs.job_id }}.json
          git commit -m "result ${{ inputs.job_id }}" || true
          git push origin progress
        env:
          NOTES: ${{ inputs.notes }}
          JOB_ID: ${{ inputs.job_id }}

      # --------------------------------------------------
      # update mirror history
      # --------------------------------------------------
      - name: Update mirror history
        if: always()
        run: |
          mkdir -p progress

          python3 << 'EOF'
          import json, os, time

          path = "progress/history.json"

          job_id = os.environ["JOB_ID"]
          run_id = os.environ["RUN_ID"]
          conclusion = os.environ.get("CONCLUSION","completed")

          now = time.strftime("%Y-%m-%d %H:%M:%S", time.gmtime())

          entry = {
              "job_id": job_id,
              "run_id": int(run_id),
              "status": conclusion,
              "time": now
          }

          try:
              with open(path) as f:
                  arr = json.load(f)
                  if not isinstance(arr, list):
                      arr = []
          except:
              arr = []

          arr.insert(0, entry)
          arr = arr[:10]

          with open(path, "w") as f:
              json.dump(arr, f, indent=2)

          EOF

          git add progress/history.json
          git commit -m "history update ${{ inputs.job_id }}" || true
          git push origin progress
        env:
          JOB_ID: ${{ inputs.job_id }}
          RUN_ID: ${{ github.run_id }}
          CONCLUSION: ${{ job.status }}

      # -----------------------------
      # finished
      # -----------------------------
      - name: Stage – finished
        if: always()
        run: |
          echo "finished" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage finished ${{ inputs.job_id }}" || true
          git push origin progress
