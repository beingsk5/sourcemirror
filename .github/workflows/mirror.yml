name: Public SourceForge Mirror

on:
  workflow_dispatch:
    inputs:
      job_id:
        required: true
        type: string

      urls:
        required: false
        type: string

      links:
        required: false
        type: string

      notes:
        required: false
        type: string

      retry_files:
        required: false
        type: string

      # new – compression object (JSON string)
      compression:
        required: false
        type: string

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # prepare progress branch
      # --------------------------------------------------
      - name: Prepare progress branch
        run: |
          git config user.name "progress-bot"
          git config user.email "progress@bot"

          git fetch origin

          if git show-ref --verify --quiet refs/remotes/origin/progress; then
            git checkout progress
            git pull origin progress
          else
            git checkout --orphan progress
            git rm -rf .
            mkdir -p progress
            git add progress
            git commit -m "init progress branch"
            git push origin progress
          fi

      # --------------------------------------------------
      # record job start time
      # --------------------------------------------------
      - name: Record job start time
        run: |
          mkdir -p work
          date +%s > work/start_time.txt

      # --------------------------------------------------
      # build working file list
      # --------------------------------------------------
      - name: Build job file list
        run: |
          mkdir -p work
          python3 << 'EOF'
          import json, os

          links = os.environ.get("LINKS")
          urls  = os.environ.get("URLS")
          retry = os.environ.get("RETRY")
          compression_raw = os.environ.get("COMPRESSION")

          compression = None
          if compression_raw:
              try:
                  compression = json.loads(compression_raw)
              except:
                  compression = None

          def archive_ext(t):
              return {
                  "zip": "zip",
                  "7z": "7z",
                  "tar.gz": "tar.gz",
                  "tar.bz2": "tar.bz2",
                  "tar.xz": "tar.xz",
                  "gz": "gz",
                  "bz2": "bz2",
                  "xz": "xz"
              }.get(t, "zip")

          files = []

          # retry mode
          if retry:
              r = json.loads(retry)
              for f in r:
                  files.append({
                      "original": f,
                      "final": f,
                      "folder": "",
                      "notes": "",
                      "status": "retry"
                  })

          # advanced mode
          elif links:
              arr = json.loads(links)

              for x in arr:
                  url = x.get("url","")
                  name = url.split("/")[-1] or "file"

                  base = x.get("rename_base") or x.get("rename") or name
                  folder = x.get("folder") or ""
                  notes  = x.get("notes") or ""

                  final = name

                  if compression and compression.get("enabled"):
                      t = compression.get("type","zip")
                      ext = archive_ext(t)
                      final = base + "." + ext
                  else:
                      r = x.get("rename")
                      if r:
                          final = r
                      else:
                          final = name

                  files.append({
                      "original": name,
                      "final": final,
                      "folder": folder,
                      "notes": notes,
                      "status": "pending"
                  })

          # old urls mode
          elif urls:
              for u in urls.splitlines():
                  u = u.strip()
                  if not u:
                      continue

                  name = u.split("/")[-1] or "file"
                  files.append({
                      "original": name,
                      "final": name,
                      "folder": "",
                      "notes": "",
                      "status": "pending"
                  })

          with open("work/files.json","w") as f:
              json.dump({
                  "compression": compression,
                  "files": files
              }, f, indent=2)

          EOF
        env:
          LINKS: ${{ inputs.links }}
          URLS:  ${{ inputs.urls }}
          RETRY: ${{ inputs.retry_files }}
          COMPRESSION: ${{ inputs.compression }}

      # -----------------------------
      # validating
      # -----------------------------
      - name: Stage – validating
        run: |
          mkdir -p progress
          echo "validating" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage validating ${{ inputs.job_id }}" || true
          git push origin progress
          sleep 20

      # -----------------------------
      # downloading
      # -----------------------------
      - name: Stage – downloading
        run: |
          echo "downloading" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage downloading ${{ inputs.job_id }}" || true
          git push origin progress
          sleep 20

      # -----------------------------
      # uploading
      # -----------------------------
      - name: Stage – uploading
        run: |
          echo "uploading" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage uploading ${{ inputs.job_id }}" || true
          git push origin progress
          sleep 20

      # -----------------------------
      # verifying
      # -----------------------------
      - name: Stage – verifying
        run: |
          echo "verifying" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage verifying ${{ inputs.job_id }}" || true
          git push origin progress
          sleep 20

      # --------------------------------------------------
      # produce result + summary
      # --------------------------------------------------
      - name: Build result and summary
        run: |
          mkdir -p progress/result

          python3 << 'EOF'
          import json, time, os

          with open("work/start_time.txt") as f:
              start = int(f.read().strip())

          with open("work/files.json") as f:
              data = json.load(f)

          files = data.get("files", [])
          compression = data.get("compression")

          for fobj in files:
              if "fail" in fobj["final"].lower():
                  fobj["status"] = "failed"
                  fobj["size"] = 0
              else:
                  fobj["status"] = "ok"
                  fobj["size"] = 123456

          total_files = len(files)
          total_size  = sum(x.get("size",0) for x in files)

          summary = {
              "total_files": total_files,
              "total_size": total_size,
              "time_taken": int(time.time() - start),
              "compression": compression
          }

          out = {
              "files": files,
              "summary": summary,
              "notes": os.environ.get("NOTES","")
          }

          with open("progress/result/${{ inputs.job_id }}.json","w") as f:
              json.dump(out,f,indent=2)

          EOF

          git add progress/result/${{ inputs.job_id }}.json
          git commit -m "result ${{ inputs.job_id }}" || true
          git push origin progress
        env:
          NOTES: ${{ inputs.notes }}

      # -----------------------------
      # finished
      # -----------------------------
      - name: Stage – finished
        if: always()
        run: |
          echo "finished" > progress/${{ inputs.job_id }}.txt
          git add progress/${{ inputs.job_id }}.txt
          git commit -m "stage finished ${{ inputs.job_id }}" || true
          git push origin progress
